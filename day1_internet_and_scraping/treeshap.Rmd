---
title: "Treeshap.Rmd"
author: "Tom Theile"
date: "28 2 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```





# Predicting the news source based on the sentiments of a headline

```{R}

if(!require(caret)){
  install.packages("caret") 
  library(caret)
}
if(!require(xgboost)){
  install.packages("xgboost") 
  library(xgboost)
}

if(!require(lightgbm)){
  install.packages("lightgbm") 
  #install.packages("lightgbm", repos = "https://cran.r-project.org")
  library(lightgbm)
}

if(!require(treeshap)){
  # install.packages("devtools")
  devtools::install_github('ModelOriented/treeshap') 
  library(treeshap)
}


dffeatures = df_headlines_sentiments[c("anger","anticipation","disgust","fear","joy","sadness","surprise","trust","negative","positive")]
dflabels = factor(df_headlines_sentiments$news_url)


param <- list(objective = "reg:squarederror", max_depth = 6)
xgb_model <-xgboost::xgboost(as.matrix(dffeatures[1:5000,]), params = param, label = dflabels[1:5000], nrounds = 200, verbose = 0)
unified <- xgboost.unify(xgb_model, dffeatures[1:5000,])
head(unified)

i_split = 5000
indexes_test = (i_split+1):10000

l = sample(1:length(dflabels),size=20)
pred <- predict(xgb_model, as.matrix(dffeatures[indexes_test,]))
print(head(pred))
pred_y = as.factor((levels(dflabels[indexes_test]))[round(pred)])
dfpred = data.frame(pred[l],dflabels[l],pred_y[l])
conf_mat = confusionMatrix(dflabels[indexes_test], pred_y[1:5000])
print(conf_mat)

err <- mean(pred_y != dflabels)
print(paste("test-error=", err))

treeshap1 <- treeshap(unified,  dffeatures, verbose = 0)
treeshap1$shaps[1:3, 1:6]
```


```{R}

if(!require(caret)){
  install.packages("caret") 
  library(caret)
}

if(!require(lightgbm)){
  install.packages("lightgbm") 
  #install.packages("lightgbm", repos = "https://cran.r-project.org")
  library(lightgbm)
}

if(!require(treeshap)){
  # install.packages("devtools")
  devtools::install_github('ModelOriented/treeshap') 
  library(treeshap)
}


dffeatures = df_headlines_sentiments[c("anger","anticipation","disgust","fear","joy","sadness","surprise","trust","negative","positive")]
dflabels = factor(df_headlines_sentiments$news_url)


n_classes=5
params = list(
    num_leaves = 4L
    , learning_rate = 1.0
    , objective = "multiclass"
    , num_class = n_classes
  )

i_split = 5000
xgb_model <-lightgbm(as.matrix(dffeatures[1:i_split,]), params = params, label = dflabels[1:i_split], nrounds = 200, verbose = 0)
unified <- lightgbm.unify(xgb_model, dffeatures[1:5000,])
head(unified)

indexes_test = (i_split+1):(i_split*2)

l = sample(1:i_split,size=20)
pred <- predict(xgb_model, as.matrix(dffeatures[indexes_test,]))
print(head(pred))


list <- list()
for (i in 1:i_split){
    max = max(result[(i-1)*n_classes+1], result[(i-1)*n_classes+2], result[(i-1)*n_classes+3], result[(i-1)*n_classes+4], result[(i-1)*n_classes+5])
    list[i] <- if_else(max == result[(i-1)*3+3], 3, if_else(max == result[(i-1)*3+2], 2, 1))
}


pred_y = as.factor((levels(dflabels[indexes_test]))[round(pred)])
dfpred = data.frame(pred[l],dflabels[l],pred_y[l])
conf_mat = confusionMatrix(dflabels[indexes_test], pred_y)
dflabels[indexes_test]
print(conf_mat)

err <- mean(pred_y != dflabels)
print(paste("test-error=", err))

treeshap1 <- treeshap(unified,  dffeatures, verbose = 0)
treeshap1$shaps[1:3, 1:6]
```



```{R}
conf_table = as.data.frame(conf_mat$table)
ggplot(conf_table, aes(Prediction,Reference, fill= Freq)) +
        geom_tile() + geom_text(aes(label=Freq)) +
        scale_fill_gradient(low="white", high="#009194") +
        labs(x = "Reference",y = "Prediction")

```


```{R}


if(!require(plotly)){
  install.packages("plotly")
  library(plotly)
}
i_headline = i_split + 1400
print(df_headlines_sentiments[i_headline,])
print(pred[i_headline-i_split])
print(pred_y[i_headline-i_split])
g = plot_contribution(treeshap1, obs = i_headline)
#ggplotly(g)
g
```

```{R}


plot_feature_importance(treeshap1, max_vars = 12)

```

```{R}

plot_feature_dependence(treeshap1, "positive")

```

```{R}

plot_feature_dependence(treeshap1, "disgust")

```



```{R}
```